<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WYSIWYG MD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Markdown Parsers -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    
    <style>
        /* ============================================================
           1. DESIGN TOKEN SYSTEM
           ============================================================ */
        :root {
            /* Surfaces */
            --bg-canvas: #F0F2F5;
            --bg-surface: #FFFFFF;
            --bg-surface-elevated: #FFFFFF;
            --bg-surface-hover: #F5F7FA;
            --bg-surface-active: #EEF1F6;
            --bg-inset: #F5F7FA;

            /* Text */
            --text-primary: #1A1D23;
            --text-secondary: #4B5563;
            --text-muted: #9CA3AF;
            --text-on-accent: #FFFFFF;
            --text-on-danger: #FFFFFF;

            /* Borders */
            --border-subtle: #E5E7EB;
            --border-strong: #D1D5DB;
            --border-focus: #6366F1;

            /* Accents */
            --accent-primary: #6366F1;
            --accent-primary-hover: #4F46E5;
            --accent-primary-soft: rgba(99, 102, 241, 0.08);
            --accent-secondary: #8B5CF6;
            --accent-danger: #EF4444;
            --accent-danger-soft: rgba(239, 68, 68, 0.08);
            --accent-success: #10B981;
            --accent-success-soft: rgba(16, 185, 129, 0.08);
            --accent-warning: #F59E0B;
            --accent-warning-soft: rgba(245, 158, 11, 0.08);

            /* Focus & Selection */
            --focus-ring: 0 0 0 2px var(--bg-surface), 0 0 0 4px var(--accent-primary);
            --selection-bg: rgba(99, 102, 241, 0.15);

            /* Radii */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Spacing */
            --space-1: 2px;
            --space-2: 4px;
            --space-3: 6px;
            --space-4: 8px;
            --space-6: 12px;
            --space-8: 16px;
            --space-10: 20px;
            --space-12: 24px;
            --space-16: 32px;
            --space-20: 40px;

            /* Shadows */
            --shadow-soft: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06);
            --shadow-large: 0 12px 40px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.06);
            --shadow-glow: 0 0 24px rgba(99, 102, 241, 0.15);

            /* Typography */
            --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-code: 'Fira Code', 'Menlo', 'Monaco', 'Consolas', monospace;
            --text-display: 700 28px/34px var(--font-ui);
            --text-h1: 600 22px/28px var(--font-ui);
            --text-h2: 600 18px/24px var(--font-ui);
            --text-body: 400 14px/22px var(--font-ui);
            --text-body-medium: 500 14px/22px var(--font-ui);
            --text-meta: 400 12px/18px var(--font-ui);
            --text-meta-medium: 500 12px/18px var(--font-ui);

            /* Layout */
            --app-bar-height: 56px;
            --command-bar-height: 48px;
            --status-bar-height: 32px;
        }

        /* DARK MODE */
        [data-theme="dark"] {
            --bg-canvas: #0F1117;
            --bg-surface: #1A1D27;
            --bg-surface-elevated: #222635;
            --bg-surface-hover: #262A3A;
            --bg-surface-active: #2D3248;
            --bg-inset: #141722;

            --text-primary: #F1F3F5;
            --text-secondary: #A1A7B5;
            --text-muted: #6B7280;

            --border-subtle: #2D3248;
            --border-strong: #3D4460;

            --accent-primary-soft: rgba(99, 102, 241, 0.15);
            --accent-danger-soft: rgba(239, 68, 68, 0.15);
            --accent-success-soft: rgba(16, 185, 129, 0.15);
            --accent-warning-soft: rgba(245, 158, 11, 0.15);

            --selection-bg: rgba(99, 102, 241, 0.25);

            --shadow-soft: 0 1px 3px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.15);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.25), 0 1px 3px rgba(0,0,0,0.2);
            --shadow-large: 0 12px 40px rgba(0,0,0,0.4), 0 4px 12px rgba(0,0,0,0.25);
            --shadow-glow: 0 0 24px rgba(99, 102, 241, 0.25);
        }

        /* ============================================================
           2. RESET & BASE
           ============================================================ */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font: var(--text-body);
            font-family: var(--font-ui);
            background: var(--bg-canvas);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        ::selection { background: var(--selection-bg); }

        :focus-visible { outline: none; box-shadow: var(--focus-ring); }

        /* ============================================================
           3. UTILITY CLASSES
           ============================================================ */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
        .separator { width: 1px; height: 24px; background: var(--border-subtle); margin: 0 var(--space-2); flex-shrink: 0; }
        .toolbar-group { display: flex; align-items: center; gap: var(--space-2); }
        .toolbar-group-label { font: var(--text-meta); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 0 var(--space-3); white-space: nowrap; user-select: none; }

        /* ============================================================
           4. TOP APP BAR
           ============================================================ */
        .app-bar {
            height: var(--app-bar-height); background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
            display: flex; align-items: center; padding: 0 var(--space-8);
            gap: var(--space-8); z-index: 50; flex-shrink: 0;
        }
        .app-bar-brand { display: flex; align-items: center; gap: var(--space-4); }
        .app-bar-logo {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: var(--radius-md); display: flex; align-items: center;
            justify-content: center; color: white; font-size: 14px;
        }
        .app-bar-title { font: var(--text-body-medium); white-space: nowrap; }
        .app-bar-spacer { flex: 1; }
        .app-bar-actions { display: flex; align-items: center; gap: var(--space-4); }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            gap: var(--space-3); font: var(--text-body-medium); border: none;
            cursor: pointer; border-radius: var(--radius-md); transition: 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--accent-primary); color: var(--text-on-accent); padding: var(--space-4) var(--space-8); box-shadow: var(--shadow-soft); }
        .btn-primary:hover { background: var(--accent-primary-hover); }
        .btn-secondary { background: var(--bg-surface); color: var(--text-primary); padding: var(--space-4) var(--space-8); border: 1px solid var(--border-subtle); }
        .btn-secondary:hover { background: var(--bg-surface-hover); }
        .btn-icon { width: 36px; height: 36px; padding: 0; background: transparent; color: var(--text-secondary); border-radius: var(--radius-md); }
        .btn-icon:hover { background: var(--bg-surface-hover); color: var(--text-primary); }
        .btn-sm { padding: var(--space-2) var(--space-4); font: var(--text-meta-medium); border-radius: var(--radius-sm); }

        /* ============================================================
           5. COMMAND BAR (Toolbar)
           ============================================================ */
        .command-bar {
            background: var(--bg-surface); border-bottom: 1px solid var(--border-subtle);
            display: flex; align-items: center; padding: var(--space-3) var(--space-8);
            gap: var(--space-3); flex-shrink: 0; overflow-x: auto; scrollbar-width: thin; z-index: 40;
        }
        .command-bar .toolbar-btn {
            width: 32px; height: 32px; display: inline-flex; align-items: center;
            justify-content: center; background: transparent; border: 1px solid transparent;
            border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer;
            transition: 0.1s; flex-shrink: 0; font-size: 13px; position: relative;
        }
        .command-bar .toolbar-btn:hover { background: var(--bg-surface-hover); color: var(--text-primary); border-color: var(--border-subtle); }
        .command-bar .toolbar-btn.active { background: var(--accent-primary-soft); color: var(--accent-primary); }
        .command-bar .toolbar-select {
            height: 32px; padding: 0 var(--space-4); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm); background: var(--bg-surface); color: var(--text-secondary);
            font: var(--text-meta); cursor: pointer; outline: none; transition: 0.1s;
        }

        /* Tooltip */
        .command-bar .toolbar-btn[data-tooltip]::after {
            content: attr(data-tooltip); position: absolute; bottom: calc(100% + 8px);
            left: 50%; transform: translateX(-50%) translateY(4px); background: var(--bg-surface-elevated);
            color: var(--text-primary); font: var(--text-meta); padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm); white-space: nowrap; box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-subtle); pointer-events: none; opacity: 0; transition: 0.1s; z-index: 100;
        }
        .command-bar .toolbar-btn[data-tooltip]:hover::after { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ============================================================
           6. WORKSPACE & VISUAL EDITOR (PROSE)
           ============================================================ */
        .workspace {
            flex: 1; display: flex; flex-direction: column; background: var(--bg-canvas);
            overflow: hidden; position: relative;
        }
        .editor-container {
            flex: 1; background: var(--bg-surface); overflow-y: auto;
            display: flex; justify-content: center; padding: var(--space-12);
        }
        
        /* The ContentEditable Area styling like a Markdown doc */
        #visualEditor {
            width: 100%; max-width: 760px; min-height: 100%;
            outline: none; font-size: 15px; line-height: 1.7;
            color: var(--text-primary); padding-bottom: 200px; /* buffer at bottom */
        }
        
        #visualEditor > *:first-child { margin-top: 0; }
        
        #visualEditor h1, #visualEditor h2, #visualEditor h3, 
        #visualEditor h4, #visualEditor h5, #visualEditor h6 {
            font-weight: 600; color: var(--text-primary); margin-top: 1.5em; margin-bottom: 0.5em; line-height: 1.3;
        }
        #visualEditor h1 { font-size: 2.2em; border-bottom: 1px solid var(--border-subtle); padding-bottom: 0.3em; }
        #visualEditor h2 { font-size: 1.8em; border-bottom: 1px solid var(--border-subtle); padding-bottom: 0.3em; }
        #visualEditor h3 { font-size: 1.4em; }
        
        #visualEditor p, #visualEditor ul, #visualEditor ol { margin-top: 0; margin-bottom: 1em; }
        #visualEditor ul, #visualEditor ol { padding-left: 1.5em; }
        #visualEditor li { margin-bottom: 0.25em; }
        
        #visualEditor blockquote {
            border-left: 4px solid var(--accent-primary); padding-left: 1em;
            margin: 1.5em 0; color: var(--text-muted); font-style: italic; background: var(--accent-primary-soft);
            padding-top: 0.5em; padding-bottom: 0.5em; border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        
        #visualEditor a { color: var(--accent-primary); text-decoration: none; font-weight: 500; }
        #visualEditor a:hover { text-decoration: underline; }
        
        #visualEditor img { max-width: 100%; height: auto; display: block; margin: 1.5em 0; border-radius: var(--radius-md); box-shadow: var(--shadow-soft); }
        
        #visualEditor pre {
            background: var(--bg-inset); padding: 1em; border-radius: var(--radius-md);
            overflow-x: auto; margin: 1.5em 0; font-family: var(--font-code); font-size: 0.9em;
            border: 1px solid var(--border-subtle);
        }
        #visualEditor code {
            background: var(--bg-inset); padding: 0.2em 0.4em; border-radius: var(--radius-sm);
            font-family: var(--font-code); font-size: 0.9em; color: var(--accent-secondary);
        }
        #visualEditor pre code { background: transparent; padding: 0; color: inherit; }

        #visualEditor hr { border: none; border-top: 2px dashed var(--border-subtle); margin: 2em 0; }

        /* ============================================================
           7. STATUS BAR
           ============================================================ */
        .status-bar {
            height: var(--status-bar-height); background: var(--bg-surface);
            border-top: 1px solid var(--border-subtle); display: flex; align-items: center;
            padding: 0 var(--space-8); gap: var(--space-8); flex-shrink: 0; z-index: 40;
        }
        .status-bar-section { display: flex; align-items: center; gap: var(--space-3); font: var(--text-meta); color: var(--text-muted); }
        .status-bar-spacer { flex: 1; }

        /* ============================================================
           8. COMPONENTS (Toasts, Modals, Menus, Error)
           ============================================================ */
        /* Toasts */
        .toast-container { position: fixed; bottom: calc(var(--status-bar-height) + var(--space-8)); left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: var(--space-3); pointer-events: none; }
        .toast { display: inline-flex; align-items: center; gap: var(--space-4); padding: var(--space-4) var(--space-8); background: var(--bg-surface-elevated); color: var(--text-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-full); box-shadow: var(--shadow-large); font: var(--text-meta-medium); opacity: 0; transform: translateY(12px) scale(0.95); transition: 0.2s; }
        .toast.show { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .toast.toast-success i { color: var(--accent-success); }
        .toast.toast-error i { color: var(--accent-danger); }

        /* Overflow Menu */
        .overflow-menu { position: absolute; top: calc(100% + var(--space-2)); right: 0; background: var(--bg-surface-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); box-shadow: var(--shadow-large); min-width: 200px; padding: var(--space-2); z-index: 100; opacity: 0; visibility: hidden; transform: translateY(-4px); transition: 0.1s; }
        .overflow-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .overflow-menu-item { display: flex; align-items: center; gap: var(--space-4); width: 100%; padding: var(--space-4) var(--space-6); border: none; background: transparent; color: var(--text-secondary); font: var(--text-body); cursor: pointer; border-radius: var(--radius-sm); text-align: left; }
        .overflow-menu-item:hover { background: var(--bg-surface-hover); color: var(--text-primary); }
        .overflow-divider { height: 1px; background: var(--border-subtle); margin: var(--space-2) 0; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.2s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-dialog { background: var(--bg-surface-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); box-shadow: var(--shadow-large); width: 90%; max-width: 440px; padding: var(--space-12); display: flex; flex-direction: column; gap: var(--space-8); transform: translateY(12px) scale(0.97); transition: 0.2s; }
        .modal-overlay.show .modal-dialog { transform: translateY(0) scale(1); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font: var(--text-h2); }
        .modal-close { width: 32px; height: 32px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; border-radius: var(--radius-sm); font-size: 18px; }
        .modal-close:hover { background: var(--bg-surface-hover); color: var(--text-primary); }
        .form-group { display: flex; flex-direction: column; gap: var(--space-2); }
        .form-label { font: var(--text-meta-medium); color: var(--text-secondary); }
        .form-input { height: 40px; padding: 0 var(--space-6); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); background: var(--bg-inset); color: var(--text-primary); font: var(--text-body); outline: none; }
        .form-input:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-primary-soft); }
        .modal-footer { display: flex; align-items: center; justify-content: flex-end; gap: var(--space-4); }

        /* Mobile Adjustments */
        @media (max-width: 767px) {
            .app-bar { padding: 0 var(--space-4); }
            .command-bar { padding: var(--space-2) var(--space-3); }
            .toolbar-group-label { display: none; }
            .editor-container { padding: var(--space-6); }
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-strong); }
    </style>
</head>
<body>

    <!-- ======== TOP APP BAR ======== -->
    <header class="app-bar" role="banner">
        <div class="app-bar-brand">
            <div class="app-bar-logo" aria-hidden="true"><i class="fa-brands fa-markdown"></i></div>
            <span class="app-bar-title">WYSIWYG MD</span>
        </div>

        <div class="app-bar-spacer"></div>

        <div class="app-bar-actions">
            <button class="btn btn-secondary btn-sm" id="uploadBtn" title="Upload MD file">
                <i class="fas fa-upload"></i> Open
            </button>
            <button class="btn btn-primary btn-sm" id="downloadBtn" title="Save as MD">
                <i class="fas fa-download"></i> Save
            </button>

            <div class="separator" aria-hidden="true"></div>

            <div style="position:relative">
                <button class="btn btn-icon" id="overflowMenuBtn" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-vertical"></i>
                </button>
                <div class="overflow-menu" id="overflowMenu">
                    <button class="overflow-menu-item" id="resetSampleBtn">
                        <i class="fas fa-rotate-left"></i> Reset to sample
                    </button>
                    <div class="overflow-divider"></div>
                    <button class="overflow-menu-item" id="themeToggleBtn">
                        <i class="fas fa-moon"></i> <span id="themeToggleLabel">Dark mode</span>
                    </button>
                </div>
            </div>

            <input type="file" id="fileInput" accept=".md,.markdown,.txt" class="sr-only">
        </div>
    </header>

    <!-- ======== COMMAND BAR ======== -->
    <nav class="command-bar" id="commandBar" role="toolbar" aria-label="Formatting toolbar">
        <!-- Undo/Redo -->
        <div class="toolbar-group">
            <button class="toolbar-btn" data-command="undo" data-tooltip="Undo (Ctrl+Z)"><i class="fas fa-rotate-left"></i></button>
            <button class="toolbar-btn" data-command="redo" data-tooltip="Redo (Ctrl+Y)"><i class="fas fa-rotate-right"></i></button>
        </div>

        <div class="separator" aria-hidden="true"></div>

        <!-- Block format -->
        <span class="toolbar-group-label" aria-hidden="true">Block</span>
        <div class="toolbar-group">
            <select id="blockFormatSelect" class="toolbar-select" title="Block format">
                <option value="p">Paragraph</option>
                <option value="h1">Heading 1</option>
                <option value="h2">Heading 2</option>
                <option value="h3">Heading 3</option>
                <option value="h4">Heading 4</option>
                <option value="h5">Heading 5</option>
                <option value="h6">Heading 6</option>
                <option value="blockquote">Quote</option>
                <option value="pre">Code Block</option>
            </select>
        </div>

        <div class="separator" aria-hidden="true"></div>

        <!-- Text group -->
        <span class="toolbar-group-label" aria-hidden="true">Text</span>
        <div class="toolbar-group">
            <button class="toolbar-btn" data-command="bold" data-tooltip="Bold (Ctrl+B)"><i class="fas fa-bold"></i></button>
            <button class="toolbar-btn" data-command="italic" data-tooltip="Italic (Ctrl+I)"><i class="fas fa-italic"></i></button>
            <button class="toolbar-btn" data-command="strikeThrough" data-tooltip="Strikethrough"><i class="fas fa-strikethrough"></i></button>
        </div>

        <div class="separator" aria-hidden="true"></div>

        <!-- Lists group -->
        <span class="toolbar-group-label" aria-hidden="true">Lists</span>
        <div class="toolbar-group">
            <button class="toolbar-btn" data-command="insertUnorderedList" data-tooltip="Bullet List"><i class="fas fa-list-ul"></i></button>
            <button class="toolbar-btn" data-command="insertOrderedList" data-tooltip="Numbered List"><i class="fas fa-list-ol"></i></button>
            <button class="toolbar-btn" data-command="outdent" data-tooltip="Decrease Indent"><i class="fas fa-outdent"></i></button>
            <button class="toolbar-btn" data-command="indent" data-tooltip="Increase Indent"><i class="fas fa-indent"></i></button>
        </div>

        <div class="separator" aria-hidden="true"></div>

        <!-- Insert group -->
        <span class="toolbar-group-label" aria-hidden="true">Insert</span>
        <div class="toolbar-group">
            <button class="toolbar-btn" id="insertLinkBtn" data-tooltip="Insert Link"><i class="fas fa-link"></i></button>
            <button class="toolbar-btn" id="insertImageBtn" data-tooltip="Insert Image"><i class="fas fa-image"></i></button>
            <button class="toolbar-btn" data-command="insertHorizontalRule" data-tooltip="Horizontal Rule"><i class="fas fa-minus"></i></button>
        </div>

        <div class="separator" aria-hidden="true"></div>

        <!-- Clear format -->
        <button class="toolbar-btn" style="color:var(--text-muted)" id="clearFormatBtn" data-tooltip="Clear Formatting">
            <i class="fas fa-eraser"></i>
        </button>
    </nav>

    <!-- ======== WORKSPACE ======== -->
    <main class="workspace">
        <div class="editor-container" id="editorContainer">
            <div id="visualEditor" contenteditable="true" aria-label="Markdown editor" spellcheck="true"></div>
        </div>
    </main>

    <!-- ======== STATUS BAR ======== -->
    <footer class="status-bar">
        <div class="status-bar-section">
            <i class="fa-brands fa-markdown"></i>
            <span>Visual Markdown</span>
        </div>
        <div class="status-bar-spacer"></div>
        <div class="status-bar-section">
            <i class="fas fa-font"></i>
            <span id="wordCount">0 words</span>
        </div>
    </footer>

    <!-- ======== TOAST CONTAINER ======== -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ======== LINK MODAL ======== -->
    <div class="modal-overlay" id="linkModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 class="modal-title">Insert Link</h2>
                <button class="modal-close" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="linkURL">URL</label>
                    <input class="form-input" type="url" id="linkURL" placeholder="https://example.com" autocomplete="off">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close-modal>Cancel</button>
                <button class="btn btn-primary" id="confirmLinkBtn"><i class="fas fa-link"></i> Insert Link</button>
            </div>
        </div>
    </div>

    <!-- ======== IMAGE MODAL ======== -->
    <div class="modal-overlay" id="imageModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 class="modal-title">Insert Image</h2>
                <button class="modal-close" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="imageURL">Image URL</label>
                    <input class="form-input" type="url" id="imageURL" placeholder="https://example.com/photo.jpg" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label" for="imageAlt">Alt text</label>
                    <input class="form-input" type="text" id="imageAlt" placeholder="Describe the image" autocomplete="off">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close-modal>Cancel</button>
                <button class="btn btn-primary" id="confirmImageBtn"><i class="fas fa-image"></i> Insert Image</button>
            </div>
        </div>
    </div>

    <!-- ======== JAVASCRIPT ======== -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        /* ==========================================================
           DOM REFERENCES & SETUP
           ========================================================== */
        const $ = sel => document.querySelector(sel);
        const $$ = sel => [...document.querySelectorAll(sel)];

        const visualEditor = $('#visualEditor');
        const wordCountText = $('#wordCount');
        
        // Buttons
        const uploadBtn = $('#uploadBtn');
        const downloadBtn = $('#downloadBtn');
        const fileInput = $('#fileInput');
        const themeToggleBtn = $('#themeToggleBtn');
        const resetSampleBtn = $('#resetSampleBtn');
        const overflowMenuBtn = $('#overflowMenuBtn');
        const overflowMenu = $('#overflowMenu');

        // Toolbar
        const commandBar = $('#commandBar');
        const blockFormatSelect = $('#blockFormatSelect');
        const clearFormatBtn = $('#clearFormatBtn');
        const insertLinkBtn = $('#insertLinkBtn');
        const insertImageBtn = $('#insertImageBtn');

        // Modals
        const linkModal = $('#linkModal');
        const imageModal = $('#imageModal');
        const confirmLinkBtn = $('#confirmLinkBtn');
        const confirmImageBtn = $('#confirmImageBtn');
        const linkURLInput = $('#linkURL');
        const imageURLInput = $('#imageURL');
        const imageAltInput = $('#imageAlt');

        let savedSelectionRange = null;

        // Turndown setup for HTML -> Markdown conversion
        const turndownService = new window.TurndownService({
            headingStyle: 'atx',
            codeBlockStyle: 'fenced',
            emDelimiter: '*'
        });
        
        // Add rule for strikethrough mapping
        turndownService.addRule('strikethrough', {
            filter: ['del', 's', 'strike'],
            replacement: (content) => `~~${content}~~`
        });

        const SAMPLE_MD = `# Welcome to WYSIWYG MD

This is a **pure Markdown editor** that lets you format text visually. No need to write syntax manually!

## Features

*   **Live Visual Editing:** Edit exactly what your content looks like.
*   **Pure Markdown Export:** Behind the scenes, it generates clean \`.md\` files.
*   **Standard Formatting:** Supports *italics*, **bold**, and ~~strikethrough~~.

### Block elements

You can easily drop in blockquotes:

> "Simplicity is the ultimate sophistication." â€” Leonardo da Vinci

Or code blocks:

\`\`\`javascript
function greet(name) {
  console.log('Hello, ' + name + '!');
}
\`\`\`

---

Try inserting a [Link to Google](https://google.com) or dragging a local \`.md\` file into this window to edit it directly!`;

        /* ==========================================================
           UTILITIES
           ========================================================== */
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icons = { success: 'fa-circle-check', error: 'fa-circle-exclamation', info: 'fa-circle-info' };
            toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i> ${message}`;
            $('#toastContainer').appendChild(toast);
            requestAnimationFrame(() => requestAnimationFrame(() => toast.classList.add('show')));
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 200); }, 2500);
        }

        function toggleTheme() {
            const next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.dataset.theme = next;
            localStorage.setItem('md-theme', next);
            $('#themeToggleLabel').textContent = next === 'dark' ? 'Light mode' : 'Dark mode';
            themeToggleBtn.querySelector('i').className = next === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function initTheme() {
            const saved = localStorage.getItem('md-theme');
            if (saved) document.documentElement.dataset.theme = saved;
            else if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.dataset.theme = 'dark';
            
            const isDark = document.documentElement.dataset.theme === 'dark';
            $('#themeToggleLabel').textContent = isDark ? 'Light mode' : 'Dark mode';
            themeToggleBtn.querySelector('i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        function updateWordCount() {
            const text = visualEditor.innerText || '';
            const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            wordCountText.textContent = `${words} word${words === 1 ? '' : 's'}`;
        }

        /* ==========================================================
           CORE LOGIC (MD <-> HTML)
           ========================================================== */
        function loadMarkdown(mdText) {
            visualEditor.innerHTML = marked.parse(mdText);
            updateWordCount();
        }

        function getMarkdown() {
            return turndownService.turndown(visualEditor.innerHTML);
        }

        function downloadFile() {
            const md = getMarkdown();
            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'document.md';
            a.click();
            URL.revokeObjectURL(a.href);
            showToast('Saved as document.md', 'success');
        }

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                loadMarkdown(e.target.result);
                showToast(`Loaded ${file.name}`, 'success');
            };
            reader.readAsText(file);
        }

        /* ==========================================================
           EDITOR EXECUTION & TOOLBAR STATE
           ========================================================== */
        function executeCommand(command, value = null) {
            visualEditor.focus();
            document.execCommand(command, false, value);
            updateToolbarState();
            updateWordCount();
        }

        function updateToolbarState() {
            const toggleCommands = ['bold','italic','strikeThrough','insertUnorderedList','insertOrderedList'];
            
            $$('[data-command]').forEach(btn => {
                const cmd = btn.dataset.command;
                if (toggleCommands.includes(cmd)) {
                    try { btn.classList.toggle('active', document.queryCommandState(cmd)); }
                    catch { btn.classList.remove('active'); }
                }
            });

            // Block format status mapping
            try {
                let block = document.queryCommandValue('formatBlock');
                if (block) {
                    block = block.replace(/[<>]/g, '').toLowerCase();
                    blockFormatSelect.value = Array.from(blockFormatSelect.options).some(o => o.value === block) ? block : 'p';
                } else {
                    blockFormatSelect.value = 'p';
                }
            } catch { blockFormatSelect.value = 'p'; }
        }

        /* ==========================================================
           SELECTION & MODALS
           ========================================================== */
        function saveSelection() {
            const sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                savedSelectionRange = sel.getRangeAt(0).cloneRange();
            }
        }

        function restoreSelection() {
            if (savedSelectionRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedSelectionRange);
            }
        }

        function openModal(modal) {
            saveSelection();
            modal.classList.add('show');
            setTimeout(() => modal.querySelector('.form-input')?.focus(), 80);
        }

        function closeModal(modal) {
            modal.classList.remove('show');
            modal.querySelectorAll('.form-input').forEach(i => i.value = '');
            visualEditor.focus();
            restoreSelection();
        }

        /* ==========================================================
           EVENT LISTENERS
           ========================================================== */
        
        // Editor interaction
        visualEditor.addEventListener('input', updateWordCount);
        visualEditor.addEventListener('keyup', updateToolbarState);
        visualEditor.addEventListener('mouseup', updateToolbarState);

        // Toolbar Buttons
        commandBar.addEventListener('click', (e) => {
            const btn = e.target.closest('.toolbar-btn[data-command]');
            if (btn) executeCommand(btn.dataset.command);
        });

        // Block Format Change
        blockFormatSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            executeCommand('formatBlock', val);
        });
        
        // Clear format
        clearFormatBtn.addEventListener('click', () => executeCommand('removeFormat'));

        // Upload / Download logic
        uploadBtn.addEventListener('click', () => fileInput.click());
        downloadBtn.addEventListener('click', downloadFile);
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        // Drag & Drop
        visualEditor.addEventListener('dragover', e => e.preventDefault());
        visualEditor.addEventListener('drop', e => {
            if (e.dataTransfer.files.length > 0) {
                e.preventDefault();
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // Top right menu
        overflowMenuBtn.addEventListener('click', e => { e.stopPropagation(); overflowMenu.classList.toggle('show'); });
        document.addEventListener('click', e => { if (!overflowMenu.contains(e.target) && e.target !== overflowMenuBtn) overflowMenu.classList.remove('show'); });
        
        themeToggleBtn.addEventListener('click', toggleTheme);
        resetSampleBtn.addEventListener('click', () => { loadMarkdown(SAMPLE_MD); overflowMenu.classList.remove('show'); showToast('Reset to sample'); });

        // Modals
        insertLinkBtn.addEventListener('click', () => openModal(linkModal));
        insertImageBtn.addEventListener('click', () => openModal(imageModal));

        $$('[data-close-modal]').forEach(btn => btn.addEventListener('click', e => closeModal(e.target.closest('.modal-overlay'))));

        confirmLinkBtn.addEventListener('click', () => {
            const url = linkURLInput.value.trim();
            if (url) {
                restoreSelection();
                executeCommand('createLink', url);
            }
            closeModal(linkModal);
        });

        confirmImageBtn.addEventListener('click', () => {
            const url = imageURLInput.value.trim();
            const alt = imageAltInput.value.trim() || 'Image';
            if (url) {
                restoreSelection();
                const imgHTML = `<img src="${url}" alt="${alt}" />`;
                executeCommand('insertHTML', imgHTML);
            }
            closeModal(imageModal);
        });

        // Initialize
        initTheme();
        loadMarkdown(SAMPLE_MD);

        // Keep editor focused when clicking empty space
        $('#editorContainer').addEventListener('click', (e) => {
            if (e.target === $('#editorContainer')) visualEditor.focus();
        });

    });
    </script>
</body>
</html>
